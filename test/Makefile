YAML_FILE=pandoc.yaml

all: examples

build/html/%.html: src/%.md ../pandoc-ling.lua
	@mkdir -p $(dir $@)
	pandoc -d $(YAML_FILE) --from=markdown --to=html $< --output=$@

build/pdf/%.pdf: build/latex/%.tex ../pandoc-ling.lua
	@mkdir -p $(dir $@)
	cd $(dir $<) ; latexmk -pdf $(notdir $<) ; latexmk -c
	mv $(<:%.tex=%.pdf) $@
	rm -f $(<:%.tex=%-tags.tex) # File generated by expex

build/latex/expex/%.tex: src/%.md ../pandoc-ling.lua
	@mkdir -p $(dir $@)
	pandoc -d $(YAML_FILE) --metadata=latexPackage=expex --from=markdown --to=latex $< --output=$@

build/latex/gb4e/%.tex: src/%.md ../pandoc-ling.lua
	@mkdir -p $(dir $@)
	pandoc -d $(YAML_FILE) --metadata=latexPackage=gb4e --from=markdown --to=latex $< --output=$@

build/latex/linguex/%.tex: src/%.md ../pandoc-ling.lua
	@mkdir -p $(dir $@)
	pandoc -d $(YAML_FILE) --metadata=latexPackage=linguex --from=markdown --to=latex $< --output=$@

build/latex/langsci/%.tex: src/%.md ../pandoc-ling.lua
	@mkdir -p $(dir $@)
	pandoc -d $(YAML_FILE) --metadata=latexPackage=langsci-gb4e --from=markdown --to=latex $< --output=$@

EXAMPLE_MD_FILES=$(wildcard src/*.md)
EXAMPLE_HTML_FILES=$(EXAMPLE_MD_FILES:src/%.md=build/html/%.html)
LING_PACKAGES=expex gb4e linguex langsci
EXAMPLE_TEX_FILES=$(foreach package,$(LING_PACKAGES),$(EXAMPLE_MD_FILES:src/%.md=build/latex/$(package)/%.tex))
EXAMPLE_PDF_FILES=$(foreach package,$(LING_PACKAGES),$(EXAMPLE_MD_FILES:src/%.md=build/pdf/$(package)/%.pdf))

examples: $(EXAMPLE_HTML_FILES)  $(EXAMPLE_TEX_FILES) $(EXAMPLE_PDF_FILES)

langsci: $(EXAMPLE_MD_FILES:src/%.md=build/latex/langsci/%.tex)
expex:   $(EXAMPLE_MD_FILES:src/%.md=build/latex/expex/%.tex)
linguex: $(EXAMPLE_MD_FILES:src/%.md=build/latex/linguex/%.tex)
gb4e:    $(EXAMPLE_MD_FILES:src/%.md=build/latex/gb4e/%.tex)

clean:
	rm -r build
